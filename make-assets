substDirList = $(foreach dir, $(1), \
	$(patsubst %.$(2), %.$(3), \
	$(patsubst asset-src/%, assets/%, $(wildcard $(dir)/*.$(2)))))
substDirListT = $(foreach dir, $(1), \
	$(patsubst %.$(2), %.$(3), \
	$(patsubst asset-src/%, asset-temp/%, $(wildcard $(dir)/*.$(2)))))
substDirListTs1 = $(foreach dir, $(1), \
	$(patsubst %.$(2), %.$(3), \
	$(patsubst asset-src/models/functions/%, asset-temp/models/%, $(wildcard $(dir)/*.$(2)))))

all: maps terrain models entity-models
	python3 tools/rebuild-index.py

maps: $(call substDirList,asset-src/maps,msf,map)

assets/maps/%.map: asset-src/maps/%.msf models
	mkdir -p assets/maps
	python3 tools/compile-map.py --level=9 $< asset-src/textures/terrain/gimpfiles/blocknames.tti $@

terrain: assets/textures/terrain/blocks.0.png

terrain-pngs: $(call substDirListT,asset-src/textures/terrain/gimpfiles,xcf,png)

asset-temp/textures/terrain/gimpfiles/%.png: asset-src/textures/terrain/gimpfiles/%.xcf
	mkdir -p asset-temp/textures/terrain/gimpfiles
	xcf2png $< > $@

assets/textures/terrain/blocks.0.png: terrain-pngs
	mkdir -p assets/textures/terrain
	python3 tools/autostitch.py assets/textures/terrain/blocks asset-src/textures/terrain/gimpfiles/blocknames.tti assets/textures/terrain/blocks.tti asset-temp/textures/terrain/gimpfiles

models: terrain modfuncs modapps assets/models/all.mfi assets/models/all.mai

assets/models/all.mfi: modfuncs
	mkdir -p asset-temp/models assets/models
	python3 tools/model-archiver.py asset-temp/models/functions/ assets/models/all.mfi asset-temp/models/functions.tab

modfuncs: $(call substDirListT,asset-src/models/functions,mdf,cmf)

asset-temp/models/functions/%.cmf: asset-src/models/functions/%.mdf
	mkdir -p asset-temp/models/ftables asset-temp/models/functions
	python3 tools/model-compiler.py $< $@ $(patsubst asset-temp/models/functions/%.cmf, asset-temp/models/ftables/%.tab, $@)

assets/models/all.mai: modapps
	mkdir -p assets/models
	python3 tools/model-archiver.py asset-temp/models/applications/ assets/models/all.mai asset-temp/models/applications.tab --magic XMDA --extension cma

modapps: assets/models/all.mfi $(call substDirListT,asset-src/models/applications,mda,cma)

asset-temp/models/applications/%.cma: asset-src/models/applications/%.mda
	mkdir -p asset-temp/models/applications
	python3 tools/model-app-compiler.py $< asset-temp/models/functions.tab asset-temp/models/ftables/ assets/textures/terrain/blocks.tti $@

entity-models: entity-parts assets/textures/entity/atlas.0.png entity-blueprints

entity-parts: $(call substDirList,asset-src/entity-models/osat,emp,osa)

assets/entity-models/osat/%.osa: asset-src/entity-models/osat/%.emp
	mkdir -p assets/entity-models/osat
	mkdir -p asset-temp/entity-models/osat
	python3 tools/part-compiler.py $< $@ \
		$(patsubst asset-src/entity-models/osat/%.emp, \
			asset-temp/entity-models/osat/%.tab, $<)

assets/textures/entity/atlas.0.png: entity-pngs
	mkdir -p assets/textures/entity
	python3 tools/samantha.py \
		assets/textures/entity/atlas assets/textures/entity/atlas.xtc \
		asset-temp/textures/entity/ \
		--binary

entity-pngs: $(call substDirListT,asset-src/textures/entity,xcf,png)

asset-temp/textures/entity/%.png: asset-src/textures/entity/%.xcf
	mkdir -p asset-temp/textures/entity
	xcf2png $< > $@

entity-blueprints: $(call substDirList,asset-src/entity-models/blueprints,emc,ebp)

assets/entity-models/blueprints/%.ebp: asset-src/entity-models/blueprints/%.emc
	mkdir -p assets/entity-models/blueprints
	python3 tools/blueprint-compiler.py $< asset-temp/entity-models/osat $@

clean:
	rm -rf asset-temp assets

yukkuri:
	@echo "ゆっくりしていってね！"
